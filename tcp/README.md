# Описание протокола

Самое простое, что я смог придумать.

## Сериализация сообщения

Метод `NChat::TMessage::Serialize`.
Выглядит так:

```
<длина_сообщения>
<автор>
<время_принятия>
<сообщение>
```

Протокол текстовый, всё это разделено через `"\n"`, все числа написаны десятично.

Здесь:

1. Длина сообщения -- длина собственно текста, то есть четвёртого поля. Сделано для того, чтобы поддерживать многострочные сообщения (клиент сейчас в силу чрезвычайной простоты не поддерживает, но это можно сделать).
1. Автор -- как представляется клиент. Чат по факту анонимный, никакой авторизации не предусмотрено. Как клиент представился, так и будет.
1. Время принятия -- UNIX time времени на сервере на момент принятия сообщения. Когда новое сообщение поступает от клиента серверу, там стоит 0, потому что это время заранее неизвестно.
1. Сообщение -- сам текст сообщения. После него всегда вставляется перевод строки, учитывающийся в первом поле как символ, и убирающийся при отображении на клиенте.

### Пример (см. файл `test/Messge.cpp`)

```
7
Alice
0
Hello!
```

Это сообщение от имени Alice, принятое 1 января 1970 года в полночь UTC с текстом `Hello!`. Или просьба серверу принять это сообщение (тогда время заранее неизвестно).

## Собственно протокол

В обе стороны протокол выглядит как бесконечный поток сообщений без указания на начало и на конец.

### Сервер -> Клиент

Когда новый клиент подключается к серверу, ему подряд посылаются все сообщения, принятые сервером к конкретному моменту времени. После этого сообщения посылаются по мере их поступления на сервер. Клиент, соответственно, просто висит на соединении, пока к нему не придёт новое сообщение, после чего отображает его и продолжает висеть.

### Клиент -> сервер

Когда пользователь отправляет сообщение, клиент пересылает его серверу, с нулевым временем принятия (будет выставлено на сервере).

### Пример (см. файл `test/Client.cpp`)

Клиент серверу:

```
7
Alice
1590510550
Hello!
17
Robert Doe
1590510610
Hi! How are you?
7
Alice
1590510670
Great!
```

Сервер клиенту:

```
7
Alice
0
Great!
```

В начале взаимодействия на сервере были следующие сообщения (время отображается как на клиенте в часовом поясе UTC+3):

```
<19:29> [Alice] Hello!
<19:30> [Robert Doe] Hi! How are you?
```

Сервер пересылает их клиенту. Клиент от имени Alice (возможно, отвалился и переподключился, а возможно, кто-то выдаёт себя за Alice из первого сообщения) отвечает `"Great!"`.
Сервер принимает это сообщение и перепосылает его клиенту, после чего клиент отображает и это сообщение:


```
<19:31> [Alice] Great!
```
